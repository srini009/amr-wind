<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Regression testing &mdash; AMR-Wind 0.1 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Verification" href="verification.html" />
    <link rel="prev" title="Unit testing" href="unit_testing.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> AMR-Wind
          </a>
              <div class="version">
                0.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../user/user.html">User Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../theory/theory.html">Theory Manual</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Developer Documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="documentation.html">Documentation - user manual and source code docs</a></li>
<li class="toctree-l2"><a class="reference internal" href="unit_testing.html">Unit testing</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Regression testing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#enabling-and-running-regression-tests">Enabling and running regression tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="#testing-against-gold-files">Testing against gold files</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#example-output-for-a-failed-test">Example output for a failed test</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#test-file-organization">Test file organization</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#creating-new-regression-tests">Creating new regression tests</a></li>
<li class="toctree-l4"><a class="reference internal" href="#test-outputs-and-troubleshooting">Test outputs and troubleshooting</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="verification.html">Verification</a></li>
<li class="toctree-l2"><a class="reference internal" href="coding_guidelines.html">Coding Guidelines</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">AMR-Wind</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Developer Documentation</a> &raquo;</li>
      <li>Regression testing</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/developer/regression_testing.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="regression-testing">
<span id="dev-reg-tests"></span><h1>Regression testing<a class="headerlink" href="#regression-testing" title="Permalink to this headline"></a></h1>
<p>AMR-Wind comes with a suite of regression tests to ensure that the relevant
parts of the code are working correctly, and any code modifications do not
introduce errors. These tests are run nightly using an automated system and the
results are published on a <a class="reference external" href="https://my.cdash.org/index.php?project=AMR-Wind">public dashboard</a>. We ensure that the testing
covers multiple operating systems (currently Linux and MacOS), different
compilers (GCC, Intel, LLVM Clang, and NVIDIA CUDA), as well as two different
versions of AMReX library – a stable monthly snapshot, and the
version-of-the-day (VOTD) development branch. In addition to the nightly
testing, <a class="reference external" href="https://github.com/Exawind/amr-wind/actions?query=workflow%3AAMR-Wind-CI">continuous integration (CI) capability</a> is used to test pull-requests to
ensure that they pass all tests before they are merged to the mainline codebase.</p>
<section id="enabling-and-running-regression-tests">
<h2>Enabling and running regression tests<a class="headerlink" href="#enabling-and-running-regression-tests" title="Permalink to this headline"></a></h2>
<p>AMR-Wind uses <a class="reference external" href="https://cmake.org/cmake/help/latest/manual/ctest.1.html">CTest</a>
and its integration with <a class="reference external" href="https://cmake.org/cmake/help/latest/manual/cmake.1.html">CMake</a> for the nightly
regression test suite. Developers can enable and use the tests locally on their
machine to assist development of new features and ensuring that the
modifications do not break current capabilities. Regression testing is not
enabled by default in a CMake build and must be enabled explicitly by the user.
To enable regression testing, the user must enable additional flags during the
CMake configure phase: <a class="reference internal" href="../user/build.html#cmakeval-AMR_WIND_ENABLE_TESTS"><code class="xref std std-cmakeval docutils literal notranslate"><span class="pre">AMR_WIND_ENABLE_TESTS</span></code></a> and
<a class="reference internal" href="../user/build.html#cmakeval-AMR_WIND_TEST_WITH_FCOMPARE"><code class="xref std std-cmakeval docutils literal notranslate"><span class="pre">AMR_WIND_TEST_WITH_FCOMPARE</span></code></a> as shown below:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>Switch to AMR-wind <span class="nb">source</span> code
<span class="go">cd ${HOME}/exawind/source/amr-wind</span>
<span class="gp"># </span>Create a build directory
<span class="go">mkdir build-test</span>
<span class="gp"># </span>Run configure with testing flags
<span class="go">cmake -DAMR_WIND_ENABLE_TESTS=ON -DAMR_WIND_TEST_WITH_FCOMPARE=ON ../</span>
<span class="gp"># </span>Build code
<span class="go">make -j 4</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>The flag <code class="docutils literal notranslate"><span class="pre">AMR_WIND_ENABLE_TESTS</span></code> activates CTest facility and enables the
use of CTest to run the regression test facility. However, this in itself
does not check whether the tests are producing the correct output. The second
flag <code class="docutils literal notranslate"><span class="pre">AMR_WIND_TEST_WITH_FCOMPARE</span></code> uses AMReX <strong class="program">fcompare</strong> utility
to test the plotfile outputs against <em>gold files</em> to ensure that the results
haven’t changed.</p>
</div>
<p>Upon successful build, you will notice that a new executable <strong class="program">fcompare</strong> is
built, and CTest has been enabled.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>List available tests
<span class="go">ctest -N</span>

<span class="gp"># </span>Run available tests <span class="o">(</span>using <span class="m">8</span> parallel processes<span class="o">)</span>
<span class="gp"># </span>show output <span class="k">if</span> a <span class="nb">test</span> fails otherwise suppress output
<span class="go">ctest -j 8 --output-on-failure</span>

<span class="gp"># </span>Run tests with that match a particular regex
<span class="go">ctest -R abl_godunov --output-on-failure -j 8</span>

<span class="gp"># </span>Rerun only tests that failed previously
<span class="go">ctest --rerun-failed --output-on-failure -j 8</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Regression testing capability is only available using the CMake build
process. The legacy GNUMakefile process does not support the regression
testing capability via CTest. The user must manually run the cases with
<strong class="program">amr_wind</strong> and then run <strong class="program">fcompare</strong> to determine issues.</p>
</div>
</section>
<section id="testing-against-gold-files">
<h2>Testing against gold files<a class="headerlink" href="#testing-against-gold-files" title="Permalink to this headline"></a></h2>
<p>To use <strong class="program">fcompare</strong> to determine if the code has been built properly and
generates the correct results, we must provide <em>gold solutions</em> for the tests.
Currently, the gold files are not released with the code, so a local copy must
be generated by the user. The recommended process is to download the appropriate
version of AMR-Wind, build and run the executable once to generate the gold
files and copy it into the appropriate directory and use them during the
development process. This is not an ideal setup and will be rectified in future.
We recommend running the unit tests to ensure that the build process worked
correctly to generate the correct executable. The gold files directory is
printed out during the configure phase, as shown below:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">-- AMR-Wind Information:</span>
<span class="go">-- CMAKE_SYSTEM_NAME = Darwin</span>
<span class="go">-- CMAKE_CXX_COMPILER_ID = AppleClang</span>
<span class="go">-- CMAKE_CXX_COMPILER_VERSION = 11.0.0.11000033</span>
<span class="go">-- CMAKE_BUILD_TYPE = RelWithDebInfo</span>
<span class="go">-- Test golds directory for fcompare: $HOME/exawind/source/amr-wind/test/AMR-WindGoldFiles/Darwin/AppleClang/11.0.0.11000033</span>
<span class="go">-- Configuring done</span>
<span class="go">-- Generating done</span>
<span class="go">-- Build files have been written to: $HOME/exawind/source/amr-wind/build-test</span>
</pre></div>
</div>
<p>The default gold files directory is
<code class="docutils literal notranslate"><span class="pre">test/AMR-WindGoldFiles/${OS}/${COMPILER}/${COMPILER_VERSION}</span></code>.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>Ensure that you are <span class="k">in</span> the build directory
<span class="gp"># </span>Run CTest first <span class="nb">time</span> <span class="o">(</span>all tests will fail as there are no golds to compare with<span class="o">)</span>
<span class="go">ctest -j 8</span>

<span class="gp"># </span>Create initial version of Golds
<span class="go">cp -R test/test_files/* &lt;absolute_path_to_test_golds&gt;</span>

<span class="gp"># </span>Rerun CTest again and all tests should pass
<span class="go">ctest -j 8</span>
</pre></div>
</div>
<section id="example-output-for-a-failed-test">
<h3>Example output for a failed test<a class="headerlink" href="#example-output-for-a-failed-test" title="Permalink to this headline"></a></h3>
<p>The following shows an example of a failed test and the typical output generated
by <code class="docutils literal notranslate"><span class="pre">fcompare</span></code> that can be used for diagnostics.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">❯ ctest -R abl_godunov$ --output-on-failure</span>
<span class="go">Test project ~/exawind/source/amr-wind/build-test</span>
<span class="go">    Start 7: abl_godunov</span>
<span class="go">1/1 Test #7: abl_godunov ......................***Failed    9.73 sec</span>

<span class="go">            variable name            absolute error            relative error</span>
<span class="go">                                        (||A - B||)         (||A - B||/||A||)</span>
<span class="go"> ----------------------------------------------------------------------------</span>
<span class="go"> level = 0</span>
<span class="go"> velx                               0.0009695495942           0.0001370997978</span>
<span class="go"> vely                               0.0009397088188           0.0001544075933</span>
<span class="go"> velz                               0.0001684407299             0.00408613285</span>
<span class="go"> gpx                                5.837947396e-05            0.003916799182</span>
<span class="go"> gpy                                5.947263951e-05            0.003794860517</span>
<span class="go"> gpz                                5.148686593e-05           0.0001801671463</span>
<span class="go"> density                                          0                         0</span>
<span class="go"> tracer0                            1.591615728e-12           5.155552515e-15</span>
<span class="go"> vort                               0.0001047506059            0.002168282324</span>


<span class="go">0% tests passed, 1 tests failed out of 1</span>

<span class="go">Label Time Summary:</span>
<span class="go">regression    =  38.90 sec*proc (1 test)</span>

<span class="go">Total Test time (real) =   9.76 sec</span>

<span class="go">The following tests FAILED:</span>
<span class="go">        7 - abl_godunov (Failed)</span>
<span class="go">Errors while running CTest</span>
</pre></div>
</div>
<p>During testing, <strong class="program">fcompare</strong> will calculate the differences for each
field in the plot file against gold files. Currently any difference is flagged
as an error and causes the test to fail as seen from the above example. The test
can also fail if the grids don’t match (e.g., due to different regrid based on
refinement criteria) or if certain fields are missing in the plot file.</p>
</section>
</section>
<section id="test-file-organization">
<h2>Test file organization<a class="headerlink" href="#test-file-organization" title="Permalink to this headline"></a></h2>
<p>The regression tests are organized in the directory
<code class="file docutils literal notranslate"><span class="pre">amr-wind/tests/test_files</span></code> and are arranged in directories corresponding
to the name of the test. Each directory contains the input file
<code class="file docutils literal notranslate"><span class="pre">&lt;test-name.i&gt;</span></code> and any other files necessary to run the test case. The
test definitions are added to <code class="file docutils literal notranslate"><span class="pre">amr-wind/tests/CTestList.cmake</span></code>.</p>
<section id="creating-new-regression-tests">
<h3>Creating new regression tests<a class="headerlink" href="#creating-new-regression-tests" title="Permalink to this headline"></a></h3>
<p>New tests can be added using the following steps:</p>
<ul class="simple">
<li><p>Create a new directory with the desired test name within the tests directory.</p></li>
<li><p>Add appropriate input files necessary to run the tests</p></li>
<li><p>Add a new entry into <code class="file docutils literal notranslate"><span class="pre">CTestList.cmake</span></code></p></li>
<li><p>Rerun CMake configure to allow CMake to detect the new tests</p></li>
<li><p>Build, test, refine the feature</p></li>
<li><p>Commit the new test directory along with relevant source code updates to Git</p></li>
</ul>
<p>For example, to create a new test called <code class="docutils literal notranslate"><span class="pre">abl_godnov</span></code> (ABL simulation using
Godunov numerical scheme). The entry in the test file is shown below</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">add_test_re(abl_godunov 4)</span>
</pre></div>
</div>
<p>The second argument to <code class="docutils literal notranslate"><span class="pre">add_test_re</span></code> indicates the number of parallel
processes used to run the test. Currently it is recommended that the tests be
run using 4 MPI ranks.</p>
</section>
<section id="test-outputs-and-troubleshooting">
<h3>Test outputs and troubleshooting<a class="headerlink" href="#test-outputs-and-troubleshooting" title="Permalink to this headline"></a></h3>
<p>During development, it is likely that some tests fail and it is necessary to
examine the outputs and plot files for troubleshooting. CTest stores all outputs
in the same directory structure as the test file but within the build directory.
For example, if the build directory is <code class="file docutils literal notranslate"><span class="pre">build-test</span></code> then the outputs for
the test <cite>abl_godunov</cite> will be stored in the directory
<code class="file docutils literal notranslate"><span class="pre">build-test/test/test_files/abl_godunov/</span></code>. At least two outputs are always
generated: a log file (e.g., <code class="file docutils literal notranslate"><span class="pre">abl_godunov.log</span></code>) that contains the output
usually printed to the console during <strong class="program">amr_wind</strong> execution, and plot
file output.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="unit_testing.html" class="btn btn-neutral float-left" title="Unit testing" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="verification.html" class="btn btn-neutral float-right" title="Verification" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>